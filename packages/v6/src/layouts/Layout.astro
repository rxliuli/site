---
import Header from '../components/Header.astro'
import Footer from '../components/Footer.astro'
import stylesUrl from '../styles/global.css?url'

interface Props {
  title: string
  description?: string
}

const { title, description = 'I like to create interesting things, using programming and writing as tools.' } =
  Astro.props
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="/logo192.jpg" />
    <link rel="preload" href={stylesUrl} as="style" />
    <link rel="stylesheet" href={stylesUrl} />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
  </head>
  <body class="min-h-screen bg-background text-foreground">
    <div class="flex min-h-screen flex-col">
      <Header />
      <main class="container mx-auto flex-1 px-4 max-w-screen-2xl">
        <slot />
      </main>
      <Footer />
    </div>
    <script>
      // Theme initialization and system theme tracking
      const applyTheme = () => {
        const savedTheme = typeof localStorage !== 'undefined' && localStorage.getItem('theme')

        if (savedTheme) {
          // User has manually set a theme preference
          if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark')
          } else {
            document.documentElement.classList.remove('dark')
          }
        } else {
          // Follow system theme
          const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches
          if (isDark) {
            document.documentElement.classList.add('dark')
          } else {
            document.documentElement.classList.remove('dark')
          }
        }
      }

      // Apply theme on load
      applyTheme()

      // Listen for system theme changes only if user hasn't set a preference
      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')
      mediaQuery.addEventListener('change', () => {
        if (!localStorage.getItem('theme')) {
          applyTheme()
        }
      })

      // Add copy buttons to code blocks
      const addCopyButtons = () => {
        const codeBlocks = document.querySelectorAll('pre')

        codeBlocks.forEach((pre) => {
          // Skip if button already exists
          if (pre.querySelector('.copy-button')) {
            return
          }

          // Create wrapper div for positioning
          const wrapper = document.createElement('div')
          wrapper.className = 'code-block-wrapper'
          pre.parentNode?.insertBefore(wrapper, pre)
          wrapper.appendChild(pre)

          // Create copy button
          const button = document.createElement('button')
          button.className = 'copy-button'
          button.innerHTML = `
            <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <svg class="check-icon hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          `

          button.addEventListener('click', async () => {
            const code = pre.querySelector('code')
            const text = code?.textContent || ''

            try {
              await navigator.clipboard.writeText(text)

              // Show check icon
              const copyIcon = button.querySelector('.copy-icon')
              const checkIcon = button.querySelector('.check-icon')
              copyIcon?.classList.add('hidden')
              checkIcon?.classList.remove('hidden')

              // Reset after 2 seconds
              setTimeout(() => {
                copyIcon?.classList.remove('hidden')
                checkIcon?.classList.add('hidden')
              }, 2000)
            } catch (err) {
              console.error('Failed to copy code:', err)
            }
          })

          wrapper.appendChild(button)
        })
      }

      // Add copy buttons after DOM is loaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', addCopyButtons)
      } else {
        addCopyButtons()
      }
    </script>
  </body>
</html>
